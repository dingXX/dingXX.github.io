<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Protocol Buffers 和 gRPC 简单了解 | cynthia'blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Protocol Buffers 和 gRPC 简单了解</h1><a id="logo" href="/.">cynthia'blog</a><p class="description">她很懒，什么都没有留下</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Protocol Buffers 和 gRPC 简单了解</h1><div class="post-meta">Jun 27, 2019<span> | </span><span class="category"><a href="/categories/技术/">技术</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Protocol-Buffers-（PB协议）"><span class="toc-number">1.</span> <span class="toc-text">Protocol Buffers （PB协议）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#特点-（和XML对比）"><span class="toc-number">1.1.</span> <span class="toc-text">特点 （和XML对比）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用"><span class="toc-number">1.2.</span> <span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-定义实体描述文件"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.定义实体描述文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-编译"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.编译</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-在项目中使用"><span class="toc-number">1.2.3.</span> <span class="toc-text">3.在项目中使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gRPC"><span class="toc-number">2.</span> <span class="toc-text">gRPC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-1"><span class="toc-number">2.1.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">3.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="fix-wrap"><div id="toc" class="toc-article toc-fixed"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Protocol-Buffers-（PB协议）"><span class="toc-number">1.</span> <span class="toc-text">Protocol Buffers （PB协议）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#特点-（和XML对比）"><span class="toc-number">1.1.</span> <span class="toc-text">特点 （和XML对比）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用"><span class="toc-number">1.2.</span> <span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-定义实体描述文件"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.定义实体描述文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-编译"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.编译</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-在项目中使用"><span class="toc-number">1.2.3.</span> <span class="toc-text">3.在项目中使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gRPC"><span class="toc-number">2.</span> <span class="toc-text">gRPC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-1"><span class="toc-number">2.1.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">3.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="post-content"><p>最近组里要求后端的接口都需要经过pb协议(Protocol Buffers) 做一层数据校验，保证接口数据结构的准确性。小白第一次听说<code>pb协议</code>，就开始查查资料，补充一下基本知识~ 就有了这个“hello word”版的笔记啦~</p>
<a id="more"></a>
<h2 id="Protocol-Buffers-（PB协议）"><a href="#Protocol-Buffers-（PB协议）" class="headerlink" title="Protocol Buffers （PB协议）"></a>Protocol Buffers （PB协议）</h2><blockquote>
<p>Protocol Buffers是google的一个开源项目。是一种灵活，高效，自动化的机制，用于序列化结构化数据。您可以定义数据的结构化结构，然后使用特殊生成的源代码轻松地将结构化数据写入和读取各种数据流。您甚至可以更新数据结构，而不会破坏根据“旧”格式编译的已部署程序。<br><a href="https://developers.google.com/protocol-buffers/docs/overview" target="_blank" rel="external">PB开发者指南</a></p>
</blockquote>
<ul>
<li>一种语言无关、平台无关、扩展性好的用于通信协议、 数据存储的结构化数据串行化方法</li>
<li>google的数据交换格式</li>
<li>类似于JSON，XML</li>
</ul>
<h3 id="特点-（和XML对比）"><a href="#特点-（和XML对比）" class="headerlink" title="特点 （和XML对比）"></a>特点 （和XML对比）</h3><ul>
<li>更简单</li>
<li>更小</li>
<li>更快</li>
<li>更小歧义</li>
<li>可以方便的生成数据存取类</li>
</ul>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ol>
<li>定义实体描述文件（建立一个<code>.proto</code>文件）</li>
<li>编译（将描述文件编译为需要读写的类）</li>
<li>在项目中使用<br> 3.1 标准化消息结构（对整个消息实体做结构检查）<br> 3.2 序列化和反序列化（消息实体和二进制流间转化）</li>
</ol>
<h4 id="1-定义实体描述文件"><a href="#1-定义实体描述文件" class="headerlink" title="1.定义实体描述文件"></a>1.定义实体描述文件</h4><p>我们需要编写一个<code>.proto</code>文件，定义我们程序中需要处理的消息实体的结构化数据</p>
<p><strong>例子1</strong> ：一个消息实体定义（JS版）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">// awesome.proto</div><div class="line">package AddressBook;  // 包名</div><div class="line">syntax = &quot;proto3&quot;; // 协议版本？？</div><div class="line">// 可以引入描述文件</div><div class="line">import &quot;../../src/pb/web.proto&quot;; </div><div class="line"></div><div class="line">// 定义消息实体</div><div class="line">message Person &#123;</div><div class="line">    required string name = 1;</div><div class="line">    optional int32 age = 2;</div><div class="line">    optional string email = 3;</div><div class="line">    enum PhoneType &#123;</div><div class="line">        MOBILE = 0;</div><div class="line">        HOME = 1;</div><div class="line">        WORK = 2;</div><div class="line">    &#125;</div><div class="line">    message PhoneNumber &#123;</div><div class="line">        string number = 1;</div><div class="line">        PhoneType type = 2;</div><div class="line">    &#125;</div><div class="line">    repeated PhoneNumber phones = 4;</div><div class="line">&#125;</div><div class="line">message AddressBook &#123;</div><div class="line">  repeated Person people = 1;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><p><strong>字段限制</strong></p>
<ul>
<li><code>required</code>:必须赋值的字段（proto3中不声明的字段默认为required） 。</li>
<li><code>optional</code>:可有可无的字段。</li>
<li><code>repeated</code>:可重复字段(变长字段),类似于数组。</li>
</ul>
</li>
<li><p><strong>类型</strong>  </p>
<ul>
<li><a href="https://developers.google.com/protocol-buffers/docs/proto3#scalar" target="_blank" rel="external">proto3语言指南</a></li>
</ul>
</li>
<li><strong>Tags</strong>  <ul>
<li>我们从message的定义看到，消息中的每一个字段后面都跟着一个数值。而这个数值作为这个字段在message中的唯一标示（Tag），序列化时相当于key-value键值对中的key。</li>
</ul>
</li>
</ul>
<h4 id="2-编译"><a href="#2-编译" class="headerlink" title="2.编译"></a>2.编译</h4><p>编写好proto文件后将其编译成对应语言的类文件</p>
<p><strong>2.1 安装ProtocolBuffer工具</strong><br>Google 没有推出官方的 JavaScript 库，但我们可以使用第三方解析库<a href="https://github.com/protobufjs/protobuf.js" target="_blank" rel="external"> ProtoBuf.js</a>。它是一个由纯 JavaScript 实现构建在 ByteBuffer.js 之上的<code>.proto</code> 文件解析库，包含 Message 构建、数据序列化和反序列化等功能。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install protobufjs</div></pre></td></tr></table></figure>
<p><strong>2.2 编译.proto文件</strong><br>我们可以使用protobuf.js提供的命令行工具来编译 .proto 文件</p>
<ul>
<li>手动编译<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># pbjs &lt;filename&gt; [options] [&gt; outFile]</span></div><div class="line"><span class="comment"># 在命令行中输入 pbjs 查看options</span></div><div class="line">pbjs server/pb/addressBook.proto -t json-module &gt; server/pb/addressBook.js</div></pre></td></tr></table></figure>
</li>
</ul>
<p>生成的js文件<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*eslint-disable block-scoped-var, id-length, no-control-regex, no-magic-numbers, no-prototype-builtins, no-redeclare, no-shadow, no-var, sort-vars*/</span></div><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">global, factory</span>) </span>&#123; <span class="comment">/* global define, require, module */</span></div><div class="line"></div><div class="line">    <span class="comment">/* AMD */</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> define === <span class="string">'function'</span> &amp;&amp; define.amd)</div><div class="line">        define([<span class="string">"protobufjs/light"</span>], factory);</div><div class="line"></div><div class="line">    <span class="comment">/* CommonJS */</span> <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">require</span> === <span class="string">'function'</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">module</span> === <span class="string">'object'</span> &amp;&amp; <span class="built_in">module</span> &amp;&amp; <span class="built_in">module</span>.exports)</div><div class="line">        <span class="built_in">module</span>.exports = factory(<span class="built_in">require</span>(<span class="string">"protobufjs/light"</span>));</div><div class="line"></div><div class="line">&#125;)(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$protobuf</span>) </span>&#123;</div><div class="line"><span class="meta">    "use strict"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> $root = ($protobuf.roots[<span class="string">"default"</span>] || ($protobuf.roots[<span class="string">"default"</span>] = <span class="keyword">new</span> $protobuf.Root()))</div><div class="line">    .addJSON(&#123;</div><div class="line">      <span class="attr">AddressBook</span>: &#123;</div><div class="line">        <span class="attr">nested</span>: &#123;</div><div class="line">          <span class="attr">Person</span>: &#123;</div><div class="line">          <span class="comment">// 这里将person的定义结构手动给删了</span></div><div class="line">          &#125;,</div><div class="line">          <span class="attr">AddressBook</span>: &#123;</div><div class="line">            <span class="attr">fields</span>: &#123;</div><div class="line">              <span class="attr">people</span>: &#123;</div><div class="line">                <span class="attr">rule</span>: <span class="string">"repeated"</span>,</div><div class="line">                <span class="attr">type</span>: <span class="string">"Person"</span>,</div><div class="line">                <span class="attr">id</span>: <span class="number">1</span></div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $root;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>在js中引用生成的js模块<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> AddressBookRoot = <span class="built_in">require</span>(<span class="string">'./pb/addressBook.js'</span>);</div><div class="line"><span class="comment">// 使用逻辑</span></div></pre></td></tr></table></figure></p>
<ul>
<li>动态编译，在代码中直接读取<code>.proto</code>文件，动态生成js模块<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ProtoBuf = <span class="built_in">require</span>(<span class="string">'protobufjs'</span>);</div><div class="line">ProtoBuf.load(<span class="string">'server/pb/addressBook.proto'</span>)</div><div class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">root</span>) </span>&#123;</div><div class="line">    <span class="comment">// 使用逻辑</span></div><div class="line">&#125;).catch(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(err);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3-在项目中使用"><a href="#3-在项目中使用" class="headerlink" title="3.在项目中使用"></a>3.在项目中使用</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ProtoBuf = <span class="built_in">require</span>(<span class="string">'protobufjs'</span>);</div><div class="line"></div><div class="line">ProtoBuf.load(<span class="string">'server/pb/addressBook.proto'</span>)</div><div class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">root</span>) </span>&#123;</div><div class="line">    <span class="comment">// 获得PersonMessage类</span></div><div class="line">    <span class="keyword">var</span> PersonMessage = root.lookupType(<span class="string">'AddressBook.Person'</span>);</div><div class="line">    <span class="comment">// 定义一个结构体例子</span></div><div class="line">    <span class="keyword">var</span> payload = &#123;</div><div class="line">        <span class="attr">name</span>:<span class="string">'cynthia'</span>,</div><div class="line">        <span class="attr">phones</span>:[&#123;</div><div class="line">            <span class="attr">number</span>:<span class="string">'88331212'</span>,</div><div class="line">            <span class="attr">type</span>:<span class="number">1</span></div><div class="line">        &#125;]</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">// 校验结构体例子是否结构正确</span></div><div class="line">    <span class="keyword">var</span> verifyErrMsg = PersonMessage.verify(payload);</div><div class="line">    <span class="keyword">if</span> (verifyErrMsg) &#123;</div><div class="line">        <span class="keyword">throw</span> verifyErrMsg</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 生成一个消息实例</span></div><div class="line">    <span class="keyword">var</span> message = PersonMessage.create(payload);</div><div class="line">    <span class="built_in">console</span>.log(message);</div><div class="line">    <span class="comment">// 序列化消息实例，转化为二进制流</span></div><div class="line">    <span class="keyword">var</span> buffer = PersonMessage.encode(message).finish();</div><div class="line">    <span class="built_in">console</span>.log(buffer);</div><div class="line">    <span class="comment">// 将二进制流方序列化为对象</span></div><div class="line">    <span class="keyword">var</span> DecodeMessage = PersonMessage.decode(buffer);</div><div class="line">    <span class="built_in">console</span>.log(DecodeMessage);</div><div class="line"></div><div class="line">&#125;).catch(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(err);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><img src="/images/pb-grpc/1.png" alt=""></p>
<p><strong>实际使用</strong></p>
<ol>
<li>更少的空间占用读写（文件存的是pb格式的buffer）</li>
<li>利用校验结构的功能，在接口输出数据前，先保证数据结构的正确性（防止静悄悄改接口数据结构）</li>
<li>基于网络的数据交换（网络传输的是pb格式的buffer），以减少传输体积<ul>
<li>连接 WebSocket，从 socket 通道拿到二进制数据，反序列化解析成 Message 对象。</li>
<li>实例化 Message 对象，然后序列化成二进制数据，发送给服务端。</li>
</ul>
</li>
</ol>
<h2 id="gRPC"><a href="#gRPC" class="headerlink" title="gRPC"></a>gRPC</h2><blockquote>
<p>gRPC是一个基于ProtoBuf(Protocol Buffers)序列化协议开发，且支持众多开发语言的开源RPC框架。<br>gRPC基于定义服务的思想，指定可以使用其参数和返回类型远程调用的方法。在服务器端，服务器实现此接口并运行gRPC服务器来处理客户端调用。在客户端，客户端有一个存根（在某些语言中称为客户端），它提供与服务器相同的方法。<br><a href="https://www.grpc.io/docs/guides/" target="_blank" rel="external">gRPC指南</a></p>
</blockquote>
<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><ol>
<li>定义消息体和RPC服务</li>
<li>实现gRPC 服务端服务器（nodeJs）</li>
<li>实现gRPC 客户端服务（nodeJs）</li>
</ol>
<p><strong>1.定义消息体和RPC服务</strong><br>在<code>user.proto</code>文件中定义一个接口类型<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">package user;</div><div class="line">syntax = &quot;proto3&quot;;</div><div class="line">// get-info 的请求数据结构</div><div class="line">message getInfoReq</div><div class="line">&#123;</div><div class="line">    optional string name = 1;   // 名称</div><div class="line">&#125;</div><div class="line">// get-info 的响应数据结构</div><div class="line">message getInfoRes</div><div class="line">&#123;</div><div class="line">    message Data</div><div class="line">    &#123;</div><div class="line">        required string name = 1;</div><div class="line">        required int32 age = 2;</div><div class="line">    &#125;</div><div class="line">    required int32 code = 1;     // code</div><div class="line">    required string message = 2;     // message</div><div class="line">    required Data data = 3;</div><div class="line">&#125;</div><div class="line">// 定义一个userService 服务</div><div class="line">service userService</div><div class="line">&#123;   </div><div class="line">    //定义一个getInfo方法</div><div class="line">    rpc GetInfo(getInfoReq) returns (getInfoRes);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>2.实现gRPC 服务端服务器</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// server/grpcDemoS.js</span></div><div class="line"><span class="keyword">var</span> grpc = <span class="built_in">require</span>(<span class="string">'grpc'</span>);</div><div class="line"><span class="keyword">var</span> protoLoader = <span class="built_in">require</span>(<span class="string">'@grpc/proto-loader'</span>);</div><div class="line"><span class="comment">// 引入定义文件</span></div><div class="line"><span class="keyword">var</span> UserProtoDefinition = protoLoader.loadSync(<span class="string">'server/pb/user.proto'</span>);</div><div class="line"><span class="comment">// 加载定义</span></div><div class="line"><span class="keyword">var</span> protoDescriptor = grpc.loadPackageDefinition(UserProtoDefinition);</div><div class="line"><span class="keyword">var</span> user = protoDescriptor.user;</div><div class="line"></div><div class="line"><span class="comment">// 创建服务</span></div><div class="line"><span class="keyword">var</span> grpc = <span class="built_in">require</span>(<span class="string">'grpc'</span>);</div><div class="line"><span class="keyword">var</span> protoLoader = <span class="built_in">require</span>(<span class="string">'@grpc/proto-loader'</span>);</div><div class="line"><span class="comment">// 引入定义文件</span></div><div class="line"><span class="keyword">var</span> UserProtoDefinition = protoLoader.loadSync(<span class="string">'server/pb/user.proto'</span>);</div><div class="line"><span class="comment">// 加载定义</span></div><div class="line"><span class="keyword">var</span> protoDescriptor = grpc.loadPackageDefinition(UserProtoDefinition);</div><div class="line"><span class="keyword">var</span> user = protoDescriptor.user;</div><div class="line"></div><div class="line"><span class="comment">// 创建一个服务器的实例。</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getServer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> server = <span class="keyword">new</span> grpc.Server();</div><div class="line">  server.addService(user.userService.service,&#123;</div><div class="line">    <span class="comment">// 定义服务的接口</span></div><div class="line">    getInfo:<span class="function"><span class="keyword">function</span> (<span class="params">call,callBack</span>) </span>&#123;</div><div class="line">        <span class="comment">// 接口处理函数</span></div><div class="line">        <span class="comment">// 获取请求数据</span></div><div class="line">        <span class="keyword">var</span> name = call.request.name;</div><div class="line">        <span class="comment">// 返回响应数据</span></div><div class="line">        callBack(<span class="literal">null</span>, &#123;<span class="attr">message</span>: <span class="string">''</span>,<span class="attr">code</span>:<span class="number">0</span>,<span class="attr">data</span>:&#123;<span class="attr">name</span>:name,<span class="attr">age</span>:<span class="number">24</span>&#125;&#125;)</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">  <span class="keyword">return</span> server;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 监听服务</span></div><div class="line"><span class="keyword">var</span> routeServer = getServer();</div><div class="line"><span class="comment">// 指定地址以及我们期望客户端请求监听的端口。</span></div><div class="line">routeServer.bind(<span class="string">'0.0.0.0:9090'</span>, grpc.ServerCredentials.createInsecure());</div><div class="line"><span class="comment">// 启动一个RPC服务器。</span></div><div class="line">routeServer.start();</div></pre></td></tr></table></figure></p>
<p><strong>3.创建gRPC 客户端</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// server/grpcDemoC.js</span></div><div class="line"><span class="keyword">var</span> grpc = <span class="built_in">require</span>(<span class="string">'grpc'</span>);</div><div class="line"><span class="keyword">var</span> protoLoader = <span class="built_in">require</span>(<span class="string">'@grpc/proto-loader'</span>);</div><div class="line"><span class="keyword">var</span> UserProtoDefinition = protoLoader.loadSync(<span class="string">'server/pb/user.proto'</span>);</div><div class="line"><span class="keyword">var</span> protoDescriptor = grpc.loadPackageDefinition(UserProtoDefinition);</div><div class="line"><span class="keyword">var</span> user = protoDescriptor.user;</div><div class="line"></div><div class="line"><span class="comment">// 客户端实例化一个服务的连接</span></div><div class="line"><span class="keyword">var</span> userService = <span class="keyword">new</span> user.userService(<span class="string">'127.0.0.1:9090'</span>,grpc.credentials.createInsecure());</div><div class="line"><span class="comment">// 调用接口方法</span></div><div class="line">userService.getInfo(&#123;<span class="attr">name</span>:<span class="string">'cynthia'</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,response</span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">        <span class="built_in">console</span>.log(err);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">console</span>.log(response);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p><strong>4.执行</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 启动服务端</div><div class="line">node server/grpcDemoS.js</div><div class="line"></div><div class="line"># 在另外一个窗口启动客户端</div><div class="line">node server/grpcDemoC.js</div></pre></td></tr></table></figure></p>
<p><img src="/images/pb-grpc/2.png" alt=""><br>请求响应参数多写的属性是不会处理的，响应数据少传参数会报错</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://imweb.io/topic/570130a306f2400432c1396c" target="_blank" rel="external">在NodeJS中玩转Protocol Buffer</a></li>
<li><a href="https://github.com/protobufjs/protobuf.js" target="_blank" rel="external">protobufjs/protobuf.js</a> protobuf github </li>
<li><a href="https://doc.oschina.net/grpc?t=60135" target="_blank" rel="external">gRPC 基础： Node.js</a>  API方法有点过时，但原理应该差不多的吧</li>
<li><a href="https://idler.me/qian-hou-duan-fen-chi-yin-ru-rpczhi-cong-ru-men-dao-fang-qi/" target="_blank" rel="external">前后端分离引入RPC之从入门到放弃</a></li>
<li><a href="https://www.grpc.io/docs/tutorials/basic/web/" target="_blank" rel="external">gRPC 官方文档</a></li>
<li><a href="https://juejin.im/post/5bd03e81e51d457a8254ed63" target="_blank" rel="external">前端 Web gRPC 实践和优化</a></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://dingxx.im/2019/06/27/pb-grpc/" data-id="cjxeqsywz0000qihgworygire" class="article-share-link">分享</a><div class="tags"></div><div class="post-nav"><a href="/2019/05/14/note-graphic-http/" class="next">《图解HTTP》笔记</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/笔记/">笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/translate/">翻译</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/JS-API/" style="font-size: 15px;">JS_API</a> <a href="/tags/flowChart/" style="font-size: 15px;">flowChart</a> <a href="/tags/canvas/" style="font-size: 15px;">canvas</a> <a href="/tags/svg/" style="font-size: 15px;">svg</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/JS/" style="font-size: 15px;">JS</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/koa2/" style="font-size: 15px;">koa2</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/笔记/" style="font-size: 15px;">笔记</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/webpack/" style="font-size: 15px;">webpack</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/06/27/pb-grpc/">Protocol Buffers 和 gRPC 简单了解</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/14/note-graphic-http/">《图解HTTP》笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/28/vue-router-keepalive/">在vue-router中使用keep-alive</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/26/node-debug/">node调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/26/iOS-pit/">iOS下遇到的前端问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/22/whatsapp-share/">调起whatsapp分享调研总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/22/koa2-note/">koa2的简单使用笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/02/draw-polyline/">svg/canvas绘制多边形</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/08/three-day-moments/">朋友圈的三天可见</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/01/git-find-bug/">git 定位问题</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">cynthia'blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>